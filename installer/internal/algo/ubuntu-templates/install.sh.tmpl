set -euox pipefail

BUNDLE_DOWNLOAD_PATH={{.BundleDownloadPath}}
BUNDLE_ADDR={{.BundleAddrs}}
IMGPKG_VERSION={{.ImgpkgVersion}}
ARCH={{.Arch}}
BUNDLE_PATH=$BUNDLE_DOWNLOAD_PATH/$BUNDLE_ADDR

if ! command -v imgpkg >>/dev/null; then
    echo "installing imgpkg"	
    
    if command -v wget >>/dev/null; then
        dl_bin="wget -nv -O-"
    elif command -v curl >>/dev/null; then
        dl_bin="curl -s -L"
    else
        echo "installing curl"
        apt-get install -y curl
        dl_bin="curl -s -L"
    fi
    
    $dl_bin github.com/vmware-tanzu/carvel-imgpkg/releases/download/$IMGPKG_VERSION/imgpkg-linux-$ARCH > /tmp/imgpkg
    mv /tmp/imgpkg /usr/local/bin/imgpkg
    chmod +x /usr/local/bin/imgpkg
fi

echo "downloading bundle"
mkdir -p $BUNDLE_PATH
imgpkg pull -i $BUNDLE_ADDR -o $BUNDLE_PATH

## disable swap
swapoff -a && sed -ri '/\sswap\s/s/^#?/#/' /etc/fstab

## disable firewall
if command -v ufw >>/dev/null; then
    ufw disable
fi

## load kernal modules
modprobe overlay && modprobe br_netfilter

## adding os configuration
tar -C / -xvf "$BUNDLE_PATH/conf.tar" && sysctl --system 

## installing kubernetes binaries directly
BIN_DIR="/usr/local/bin"
CNI_DIR="/opt/cni/bin"

# Create necessary directories
mkdir -p $BIN_DIR $CNI_DIR

# Install kubectl, kubelet, kubeadm, and crictl
echo "Installing Kubernetes binaries..."
cp "$BUNDLE_PATH/bin/kubectl" "$BIN_DIR/kubectl"
cp "$BUNDLE_PATH/bin/kubelet" "$BIN_DIR/kubelet"
cp "$BUNDLE_PATH/bin/kubeadm" "$BIN_DIR/kubeadm"
cp "$BUNDLE_PATH/bin/crictl" "$BIN_DIR/crictl"

# Ensure binaries are executable
chmod +x "$BIN_DIR/kubectl" "$BIN_DIR/kubelet" "$BIN_DIR/kubeadm" "$BIN_DIR/crictl"

# Install CNI plugins
echo "Installing CNI plugins..."
mkdir -p "$CNI_DIR"
tar -C "$CNI_DIR" -xzf "$BUNDLE_PATH/cni-plugins.tgz"

# Create kubelet systemd service file
cat > /etc/systemd/system/kubelet.service << EOF
[Unit]
Description=kubelet: The Kubernetes Node Agent
Documentation=https://kubernetes.io/docs/home/
Wants=network-online.target
After=network-online.target

[Service]
ExecStart=$BIN_DIR/kubelet
Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Create kubelet configuration directory
mkdir -p /etc/kubernetes/manifests

## intalling containerd
tar -C / -xvf "$BUNDLE_PATH/containerd.tar"
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml
{{.ContainerdConfig}}

## starting containerd service
systemctl daemon-reload && systemctl enable containerd && systemctl start containerd

echo "Installation complete!"
