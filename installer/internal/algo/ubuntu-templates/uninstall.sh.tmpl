set -euox pipefail

BUNDLE_DOWNLOAD_PATH={{.BundleDownloadPath}}
BUNDLE_ADDR={{.BundleAddrs}}
BUNDLE_PATH=$BUNDLE_DOWNLOAD_PATH/$BUNDLE_ADDR

## disabling containerd service
systemctl stop containerd && systemctl disable containerd && systemctl daemon-reload

## removing containerd configurations and cni plugins
rm -rf /opt/cni/ && rm -rf /opt/containerd/ 
if [ -f "$BUNDLE_PATH/containerd.tar" ]; then
  tar tf "$BUNDLE_PATH/containerd.tar" | xargs -n 1 echo '/' | sed 's/ //g'  | grep -e '[^/]$' | xargs rm -f
fi

## removing directly installed kubernetes binaries
BIN_DIR="/usr/local/bin"
CNI_DIR="/opt/cni/bin"

# Stop kubelet service if running
echo "Stopping kubelet service..."
systemctl stop kubelet || true
systemctl disable kubelet || true

# Remove systemd service file
echo "Removing kubelet service file..."
rm -f /etc/systemd/system/kubelet.service
systemctl daemon-reload

# Remove binaries
echo "Removing Kubernetes binaries..."
rm -f "$BIN_DIR/kubectl" "$BIN_DIR/kubelet" "$BIN_DIR/kubeadm" "$BIN_DIR/crictl"

# Remove CNI plugins directory
echo "Removing CNI plugins..."
rm -rf "$CNI_DIR"

# Remove Kubernetes directories
echo "Removing Kubernetes directories..."
rm -rf /etc/kubernetes
rm -rf /var/lib/kubelet
rm -rf /var/lib/kubernetes

## removing os configuration
if [ -f "$BUNDLE_PATH/conf.tar" ]; then
    tar tf "$BUNDLE_PATH/conf.tar" | xargs -n 1 echo '/' | sed 's/ //g' | grep -e "[^/]$" | xargs rm -f
else
    echo "Warning: conf.tar not found, skipping OS configuration removal"
fi

## remove kernal modules
modprobe -rq overlay || true && modprobe -r br_netfilter || true

## enable firewall
if command -v ufw >>/dev/null; then
    ufw enable
fi

## enable swap
swapon -a && sed -ri '/\sswap\s/s/^#?//' /etc/fstab

rm -rf $BUNDLE_PATH
